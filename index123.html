
<html>
<head>
<title>INFO 3300 - Data-driven Web Applications</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="js/nouislider.js"></script>
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" href="css/nouislider.css" />  
<style type="text/css">

h1 {
    font-family: "Roboto Slab", serif;
    color: #cc0000;
    margin-left: 20px;

}

body {
    font-family: "Roboto", sans-serif;
    margin: 30px 60px 60px 30px;
    background-color: #0e151c;
}

.overlay {
    height: 0;
    width: 0;
    left: 0;
    top: 0;
    position: absolute;
    z-index: 1;
    background-color: #cc0000;
    overflow-y: scroll;
}

.graphic {
    z-index:0;
}

.animalClass {
    z-index: 2;
    color: #fbfbfb;
    font-size: 18px;
    font-family: "Roboto", sans-serif;
    margin-top: 4em;
    margin-bottom: 4em;
    margin-left: 35%;
}

.species {
    z-index: 2;
    color: #f6f6f6;
    font-size: 16px;
    font-family: "Roboto light", sans-serif;
    margin-top: 0.5em;
    margin-bottom: 0.5em;

}

.icons {
    margin: 40px 30px 20px 75px;
    padding: 3px;
    border-color: #efefef;
    border-radius: 50px;
    box-shadow: 0 0 0 rgba(255, 115, 115, 0.7);
    animation: pulse 2s infinite;
}

.circles {
    cursor: pointer;
}

#slider {
    margin-bottom: 20px;
}

#countryHover {
    font-size: 80%;
    color: rgb(80,0,0);
}

/*pulse animation code from http://codepen.io/olam/pen/zcqea*/
@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 115, 115, 0.7);
  }
  70% {
      box-shadow: 0 0 5px 10px rgba(255, 115, 115, 0);
  }
  100% {
      box-shadow: 0 0 0 0 rgba(255, 115, 115, 0);
  }
}
</style>

</head>

<body>
<h1>
The Sixth Extinction
</h1>

<div id="myNav" class="overlay"></div>
<div id="map" class="graphic"></div>
<div id="slider" class="graphic"></div>
<div class="buttons">
    <!-- image from http://www.iconninja.com/mole-mammal-animal-shape-icon-858145 -->
    <input class="icons" id="mammalExtinction" type="image" src="icons/mammal.png" 
    alt="Mammal" width="72" height="72" value="Mammal"/>

    <!-- image from http://www.rw-designer.com/icon-detail/8823 -->
    <input class="icons" id="birdButton" type="image" src="icons/bird.png" 
    alt="Bird" width="72" height="72" value="Bird"/>

    <!-- image from https://wikispaces.psu.edu/display/Herps/Christianna+Stang -->
    <input class="icons" id="amphibianButton" type="image" src="icons/amphibian.png" 
    alt="Amphibian" width="72" height="72" value="Amphibian"/>

            <!-- image from http://www.clipartbest.com/fish-icon-png -->
    <input class="icons" id="fishButton" type="image" src="icons/fish.png" 
    alt="Fish" width="72" height="72" value="Fish"/>

    <!-- image from http://www.iconsdb.com/black-icons/ant-3-icon.html -->
    <input class="icons" id="insectButton" type="image" src="icons/insect.png" 
    alt="Insect" width="72" height="72" value="Insect"/>

    <!-- image from http://www.clker.com/clipart-black-shrimp-icon.html -->
    <input class="icons" id="crustaceanButton" type="image" src="icons/crustacean.png" 
    alt="Crustacean" width="72" height="72" value="Crustacean"/>
</div>
<div id="toggle">
    <input name="updateButton" 
           type="button" 
           value="Update" 
           onclick="updateData()" />
</div>

<script type="text/javascript">

var width = 1400,
    height = 500,
    padding = 20;

//Setting projection
var projection = d3.geoRobinson().scale(180).translate([width / 2 - 150, height / 2 + 20]);

var path = d3.geoPath().projection(projection);

var circleScale = d3.scaleLinear().domain([1,52]).range([5,50]);
//SVG container

var svg = d3.select("#map").append("svg")
.attr("width", width)
.attr("height", height);

var layer1 = svg.append("g");
var layer2 = svg.append("g");

d3.queue()
.defer(d3.json, "continent-110m.json")
.defer(d3.csv, "worldPopulation.csv")
.defer(d3.csv, "populationBefore1960.csv")
.defer(d3.csv, "extinction-by-time.csv")
.defer(d3.csv, "coordinates.csv")
//Main function
.await(function (error, world, population, popuByContinent, extinctionData, coordinates) {

    //make data into numbers
    popuByContinent.forEach(function(d) {
        for (var year = 1500; year <= 1900; year += 100) {
        d[year] = Number(d[year]);
        };
        d[1950] = Number(d[1950]);
    });

    population.forEach(function(d) {
        for (var year = 1960; year <= 2010; year += 10) {
            d[year] = Number(d[year]);
        }
        d.id = Number(d.id);
    });

    //create slider
    //slider source https://refreshless.com/nouislider/ see separate js file
    var slider = document.getElementById("slider");

    var range_all_sliders = {
        'min': [ 1500, 100 ],
        '60%': [ 1900, 50],
        '70%': [ 1950, 10 ],
        'max': [ 2010 ]       
    };

    noUiSlider.create(slider, {
        connect: true,
        behaviour: "drag",
        range: range_all_sliders,
        start: [ 1800, 2010 ],
        pips: {
            mode: 'values',
            values: [1500, 1600, 1700, 1800, 1900, 1950, 1960,
                    1970, 1980, 1990, 2000, 2010],
            density: 100,
            stepped: true
        }
    });

    slider.noUiSlider.on("update", function (values) {
        var from = Number(values[0]);
        var to = Number(values[1]);

        drawContinent(world, popuByContinent, population, to);
        mapExtinction(extinctionData, from, to, coordinates, "#cc0000");
    });


    //show extinction by animal class selection

    var animalClassColors = ["#ffcc00","#ff8c1a","#C26C55","#C23C5F","#f53dc7","#751aff"];

    var allButtons = d3.selectAll(".icons");

    allButtons.on("click", function(d, i) {
        var animalValue = String(this.value);
        var dataByClass = extinctionData.filter(function(d) { return d["Animal Class"] == animalValue; });
        var yearRange = slider.noUiSlider.get();
        mapExtinction(dataByClass, yearRange[0], yearRange[1], coordinates, animalClassColors[i])
    })
    .on("mouseover", function() {
        d3.select(this).style("background-color", "#cc0000");
    })
    .on("mouseout", function() {
        d3.select(this).style("background-color", "transparent");
    });

});


function mapExtinction(data, from, to, coordinates, color) {

    var data = extinctionByInterval(data, from, to);
    var occurrence = countOccurrence(data);

    //nesting data by country 
    //add coordinates and occurrence
    nestedData = d3.nest().key(function(d) { return d.country; })
        .entries(data);

    nestedData.forEach(function(d) {
        coordinates.forEach(function(e) {
            if (e.name == d.key) {
                d.coordinates = [Number(e.longitude), Number(e.latitude)];    
            }
        });
        var country = d.key
        d.count = occurrence[country];
    })

    var circles = layer2.selectAll("circle").data(nestedData);

    circles.exit().remove();

    circles.enter().append("circle")
    .merge(circles)
    .attr("class", "circles")
    .attr("cx", function(d) { return projection(d.coordinates)[0]; })
    .attr("cy", function(d) { return projection(d.coordinates)[1]; })
    .transition(4000)
    .attr("r", function(d) { return circleScale(d.count); })
    .style("fill", color)
    .style("opacity", 0.8);

    //country names on hover
    var countryHover = d3.select("body")
        .append("div")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden");

    //mouseover functions
    circles
    .on("mouseover", function(d) { 
        d3.select(this).attr("r", function(d) { return circleScale(d.count) + 5; }).style("opacity", 1);
        return countryHover
        .style("visibility", "visible")
        .style("background", "white")
        .style("padding", 2)
        .style("opacity", 0.8)
        .text(d.key); 
        })

    .on("mousemove", function() { 
        d3.select(this).attr("r", function(d) { return circleScale(d.count) + 5; }).style("opacity", 1);
        return countryHover.style("top", (event.pageY - 10) + "px").style("left", (event.pageX + 10) + "px"); })

    .on("mouseout", function() { 
        d3.select(this).attr("r", function(d) { return circleScale(d.count); }).style("opacity", 0.8);
        return countryHover.style("visibility", "hidden") })


    //show extinct animal list of that country within selected time frame
    circles.on("click", function(d) {
        var arrayOfValues = d.values;

        var classList = [];

        arrayOfValues.forEach (function (d) {
            if (classList.indexOf(d.animalClass) == -1){
                classList.push(d.animalClass);
            };
        });

        classList.sort();

        d3.select(".overlay").style("width", "100%").style("height", "100%").style("opacity", 0.95);

        classList.forEach(function(d) {
            d3.select("#myNav").append("div")
            .attr("class", "animalClass")
            .attr("id", d)
            .text(d)
        });

        arrayOfValues.forEach(function(d) {
            d3.select("#"+d.animalClass).append("div")
            .attr("class", "species")
            .text(d.name + "  ,   " + d.extinctionTime);
        });
    });

    var screen = d3.select("#myNav");

    screen.on("click", function(d) {
        screen.style("width", "0%");
        d3.selectAll(".animalClass").remove();
        d3.selectAll(".species").remove();
    });
}


//helper to count occurrence of extinction in each country
function countOccurrence(array) {
    var countryList = [];

    array.forEach(function(d) {
        countryList.push(d.country);
    });
    countryList.sort();

    var occurrence = {};

    for (var i = 0, j = countryList.length; i < j; i ++) {
        occurrence[countryList[i]] = (occurrence[countryList[i]] || 0) + 1;
    }    
    return occurrence;
}


//helper to create extinction dataset within the input time frame
function extinctionByInterval(data, time1, time2) {
    var extinctionByInterval = [];
    data.forEach(function(d) {
        var value = new Object();
        if (d.Year >= time1 && d.Year < time2) {
            value.animalClass = d["Animal Class"];
            value.name = d["Common Name"]; 
            if (d["Common Name"] == "") {
                value.name = d["Species Name"];
                }
            value.extinctionTime = Number(d.Year);
            value.country = d.Countries.trim();
            extinctionByInterval.push(value);
        };
    });
    return extinctionByInterval; 
}


function drawContinent(data, popuContinent, popuCountry, time) {

    var countries = topojson.feature(data, data.objects.countries).features;

    //find maximum population density
    var maxPopu = d3.max(popuCountry, function (d) {return d[2010];});

    var color = ["#c3d1e0", "#b8c7d7", "#abbaca", "#9dadbe", "#8da0b3", "#7d92a8", "#758ba2", "#758ba2", "#667e97", 
                "#5e7791", "#56708c", "#4e6a86", "#466381", "#3e5c7b", "#385776", "#335171", "#274767"];

    var colorScale = d3.scaleLinear().domain([0, Math.log(maxPopu)]).range(color);


    //draw map with population by continents
    if (time < 1960) {
        //creating data to draw continents
        //code simplified from http://geojson.org/geojson-spec.html#introduction
        var continentNames = ["Asia", "Africa", "Europe", "North America", "South America", "Oceania"];
        var continents = [];
        continentNames.forEach(function(d, i) {
        var continentName = d;
        var value = {type: "FeatureCollection", name: d, id: i + 1, 
                    color: colorScale(popuContinent[i][time]),
                    features: countries.filter(function(d) { return d.properties.continent == continentName; })
        };
        continents.push(value);
    });

        var map = layer1.selectAll("path").data(continents);

        map.enter().append("path")
            .merge(map)
            .attr("d", path)
            .transition(300)           
            .style("fill", function(d) { return d.color; })
            .style("stroke-width", 0.5)
            .style("stroke", "#8da0b3");
        map.exit().remove();
    } 

    //draw map with population by countries
    else {
        popuIdAndTime = [];

        popuCountry.forEach(function(d) {
            var id = d.id;
            var population = d[time];
            popuIdAndTime.push({id:id, population:population});
        })

        countries.forEach(function(d) {
            popuIdAndTime.forEach(function(e) {
                if (e.id == d.id) {
                    d.color = colorScale(e.population);
                }
            })
        });

        var map = layer1.selectAll("path").data(countries);

        map.enter().append("path")
            .merge(map)
            .attr("d", path)
            .transition(300)
            .style("fill", function(d) { return d.color; })
            .style("stroke-width", 0.5)
            .style("stroke", "#8da0b3");
        map.exit().remove();      
    }
}
// function createSlider() {
//     var svg = d3.select("#slider"),
//     margin = {right: 50, left: 50},
//     width = width - margin.left - margin.right,
//     height = 200;

//     var x = d3.scaleLinear()
//         .domain([0, 180])
//         .range([0, width])
//         .clamp(true);

//     var slider = svg.append("g")
//         .attr("class", "slider")
//         .attr("transform", "translate(" + margin.left + "," + height / 2 + ")");

//     slider.append("line")
//         .attr("class", "track")
//         .attr("x1", 0)
//         .attr("x2", 800)
//       .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
//         .attr("class", "track-inset")
//       .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
//         .attr("class", "track-overlay")
//         .call(d3.drag()
//             .on("start.interrupt", function() { slider.interrupt(); })
//             .on("start drag", function() { hue(x.invert(d3.event.x)); }));

//     slider.insert("g", ".track-overlay")
//         .attr("class", "ticks")
//         .attr("transform", "translate(0," + 20 + ")")
//       .selectAll("text")
//       .data(x.ticks(100))
//       .enter().append("text")
//         .attr("x", x)
//         .attr("text-anchor", "middle")
//         .text(function(d) { return d; });

//     var handle = slider.insert("circle", ".track-overlay")
//         .attr("class", "handle")
//         .attr("r", 9);

//     var handle2 = slider.insert("circle", ".track-overlay")
//         .attr("class", "handle")
//         .attr("cx", 500)
//         .attr("r", 9);

//     // slider.transition() // Gratuitous intro!
//     //     .duration(750)
//     //     .tween("hue", function() {
//     //       var i = d3.interpolate(0, 70);
//     //       return function(t) { hue(i(t)); };
//     //     });

//     // function hue(h) {
//     //   handle.attr("cx", x(h));
//     //   svg.style("background-color", d3.hsl(h, 0.8, 0.8));
//     // }
// }

// function createSlider() {
//     scale = d3.scaleLinear().domain([1500, 2010]).range([padding, width-padding]);
//     slider = d3.select("#range-slider")

//     drag = d3.drag()
//     .on "drag", ()
// }

// function drawCountry(data, popu, time) {
//   var countries = topojson.feature(data, data.objects.countries).features;
//   var max = d3.max(popu, function (d) {return d[2010];});
//   var colorScale = d3.scaleLinear().domain([0, Math.log(max)]).range(['#f0f0f0','#d9d9d9','#bdbdbd','#969696','#737373','#525252','#252525','#000000']);

//   var populationAtTime = [];

//   popu.forEach(function(d) {
//     var object = new Object();
//     object.id = d.id;
//     console.log(d.time);
//     object.population = d.time;
//     populationAtTime.push(object);
//   });

//   // console.log(populationAtTime);

//   var map = svg.selectAll("path.land").data(countries)
//   .enter().append("path")
//   .attr("class", "land")
//   .attr("d", path)
//   .style("stroke", "white")
//   ;
// }



// function extinctionByTime(data) {
//   var extinctionByTime = [];
//   var timeSeries = [1500, 1600, 1700, 1800, 1900, 1950, 1960, 1970, 1980, 1990, 2000, 2010];
//   timeSeries.forEach(function(d, i) {
      
//       var value = new Object();
//       var temp = [];
//       if (i == 0) {
//           value.year = d;
//       } else {
//           var leftTime = timeSeries[i - 1];
//           var rightTime = timeSeries[i];
//           data.forEach(function(d) {
//               value.year = rightTime;
//               if (d.Year >= leftTime && d.Year < rightTime) {
//                   var tmp = new Object();
//                   tmp.animalClass = d["Animal Class"];
//                   var specieName = d["Species Name"];
//                   var commonName = d["Common Name"];
//                   if (typeof(commonName) == "undefined")
//                       tmp.name = specieName;
//                   else tmp.name = commonName;
//                   if (typeof(tmp.name) == "undefined")
//                       console.log("warning, undefined name");
//                   tmp.extinctionTime = d.Year;
//                   var country = d.Countries.split(",");
//                   tmp.country = country;
//                   temp.push(tmp);
//               }
//           });
//       }
//       value.extinction = temp;
//       extinctionByTime.push(value);
//   });
//   return extinctionByTime;
// }
</script>

</body>