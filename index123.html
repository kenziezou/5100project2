
<html>
<head>
<title>INFO 3300 - Data-driven Web Applications</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<style type="text/css">
</style>

</head>

<body>
<select id="year1">
    <option value="1500" selected="selected">1500</option>
    <option value="1600">1600</option>
    <option value="1700">1700</option>
    <option value="1800">1800</option>
    <option value="1900">1900</option>
    <option value="1950">1950</option>
    <option value="1960">1960</option>
    <option value="1970">1970</option>
    <option value="1980">1980</option>
    <option value="1990" >1990</option>
    <option value="2000">2000</option>
</select>
<select id="year2">
    <option value="1600">1600</option>
    <option value="1700">1700</option>
    <option value="1800">1800</option>
    <option value="1900">1900</option>
    <option value="1950">1950</option>
    <option value="1960">1960</option>
    <option value="1970">1970</option>
    <option value="1980">1980</option>
    <option value="1990">1990</option>
    <option value="2000">2000</option>
    <option value="2010" selected="selected">2010</option>
</select>

<div id="map"></div>

<script type="text/javascript">

var width = 1200,
    height = 600;

//Setting projection
var projection = d3.geoRobinson().scale(180).translate([width / 2 - 150, height / 2]);

var path = d3.geoPath().projection(projection);

//SVG container
var svg = d3.select("#map").append("svg")
.attr("width", width)
.attr("height", height);

d3.queue()
.defer(d3.json, "continent-110m.json")
.defer(d3.csv, "worldPopulation.csv")
.defer(d3.csv, "populationBefore1960.csv")
.defer(d3.csv, "extinction-by-time.csv")
.defer(d3.csv, "coordinates.csv")
//Main function
.await(function (error, world, population, popuByContinent, extinctionData, coordinates) {

    //make data into numbers
    popuByContinent.forEach(function(d) {
        for (var year = 1500; year <= 1900; year += 100) {
        d[year] = Number(d[year]);
        };
        d[1950] = Number(d[1950]);
    });

    population.forEach(function(d) {
        for (var year = 1960; year <= 2010; year += 10) {
            d[year] = Number(d[year]);
        }
        d.id = Number(d.id);
    });

    //extinction data by time
    var year1 = d3.select("#year1").node().value;
    var year2 = d3.select("#year2").node().value;

    //Draw initial continents
    drawContinent(world, popuByContinent, population, year2);

    d3.select("#year2").on("click", function() {
    var selection = d3.select("#year2").node().value;
        drawContinent(world, popuByContinent, population, selection);
    });

    extinctionByInterval = extinctionByInterval(extinctionData, year1, year2);
    mapExtinction(extinctionByInterval, coordinates);

});


function extinctionByInterval(data, time1, time2, coordinates) {

    var extinctionByInterval = [];
    data.forEach(function(d) {
        var value = new Object();
        if (d.Year >= time1 && d.Year < time2) {
            value.animalClass = d["Animal Class"];
            value.name = d["Common Name"]; 
            if (typeof(d["Common Name"]) == "undefined") {
                value.name = d["Species Name"];
                }
            value.extinctionTime = Number(d.Year);
            value.country = d.Countries.trim();
            extinctionByInterval.push(value);
        };
    });

    console.log(extinctionByInterval);
    return extinctionByInterval; 

}


function mapExtinction(data, coordinates) {

    var occurrence = countOccurrence(data);
    console.log(occurrence);

    data.forEach(function(d) {
        coordinates.forEach(function(e) {
            if (e.name == d.country) {
                d.coordinates = [Number(e.longitude), Number(e.latitude)];    
            }
        });
        var country = d.country;

    });


    circles = svg.selectAll("circles").data(data);

    circles.enter().append("circle")
    .merge(circles)
    .attr("r", function(d) {
        var name = d.country;
        console.log(occurrence.name);
        return occurrence.name;
    })
    .attr("cx", function(d) { return projection(d.coordinates)[0]; })
    .attr("cy", function(d) { return projection(d.coordinates)[1]; })
    .style("fill", "red");


    //helper to count occurrence of extinction in each country
    function countOccurrence(array) {
        var countryList = [];

        array.forEach(function(d) {
            countryList.push(d.country);
        });
        countryList.sort();

        var occurrence = {};

        for (var i = 0, j = countryList.length; i < j; i ++) {
            occurrence[countryList[i]] = (occurrence[countryList[i]] || 0) + 1;
        }
        
        return occurrence;
    }

}


function drawContinent(data, popuContinent, popuCountry, time) {

    var countries = topojson.feature(data, data.objects.countries).features;

    //find maximum population density
    var maxPopu = d3.max(popuCountry, function (d) {return d[2010];});

    var color = ['#ebf2fa','#d6e6f5','#c2d9f0','#adcceb','#99bfe6','#85b3e0','#70a6db','#5c99d6','#478cd1','#3380cc', 
    '#2e73b8','#2966a3','#24598f','#1f4d7a'];

    var colorScale = d3.scaleLinear().domain([0, Math.log(maxPopu)]).range(color);

    if (time < 1960) {
        //creating data to draw continents
        //code simplified from http://geojson.org/geojson-spec.html#introduction
        var continentNames = ["Asia", "Africa", "Europe", "North America", "South America", "Oceania"];
        var continents = [];
        continentNames.forEach(function(d, i) {
        var continentName = d;
        var value = {type: "FeatureCollection", name: d, id: i + 1, 
                    color: colorScale(popuContinent[i][time]),
                    features: countries.filter(function(d) { return d.properties.continent == continentName; })
        };
        continents.push(value);
    });

        var map = svg.selectAll("path").data(continents);
        map.enter().append("path")
            .merge(map)
            .transition(500)
            .attr("d", path)
            .style("fill", function(d) { return d.color; });

        map.exit().remove();
    } 

    else {
        popuIdAndTime = [];

        popuCountry.forEach(function(d) {
            var id = d.id;
            var population = d[time];
            popuIdAndTime.push({id:id, population:population});
        })

        countries.forEach(function(d) {
            popuIdAndTime.forEach(function(e) {
                if (e.id == d.id) {
                    d.color = colorScale(e.population);
                }
            })
        });

        var map = svg.selectAll("path").data(countries);
        map.enter().append("path")
            .merge(map)
            .transition(500)
            .attr("d", path)
            .style("fill", function(d) { return d.color; });      

        map.exit().remove();
    }


}

// function drawCountry(data, popu, time) {
//   var countries = topojson.feature(data, data.objects.countries).features;
//   var max = d3.max(popu, function (d) {return d[2010];});
//   var colorScale = d3.scaleLinear().domain([0, Math.log(max)]).range(['#f0f0f0','#d9d9d9','#bdbdbd','#969696','#737373','#525252','#252525','#000000']);

//   var populationAtTime = [];

//   popu.forEach(function(d) {
//     var object = new Object();
//     object.id = d.id;
//     console.log(d.time);
//     object.population = d.time;
//     populationAtTime.push(object);
//   });

//   // console.log(populationAtTime);

//   var map = svg.selectAll("path.land").data(countries)
//   .enter().append("path")
//   .attr("class", "land")
//   .attr("d", path)
//   .style("stroke", "white")
//   ;
// }




// function extinctionByTime(data) {
//   var extinctionByTime = [];
//   var timeSeries = [1500, 1600, 1700, 1800, 1900, 1950, 1960, 1970, 1980, 1990, 2000, 2010];
//   timeSeries.forEach(function(d, i) {
      
//       var value = new Object();
//       var temp = [];
//       if (i == 0) {
//           value.year = d;
//       } else {
//           var leftTime = timeSeries[i - 1];
//           var rightTime = timeSeries[i];
//           data.forEach(function(d) {
//               value.year = rightTime;
//               if (d.Year >= leftTime && d.Year < rightTime) {
//                   var tmp = new Object();
//                   tmp.animalClass = d["Animal Class"];
//                   var specieName = d["Species Name"];
//                   var commonName = d["Common Name"];
//                   if (typeof(commonName) == "undefined")
//                       tmp.name = specieName;
//                   else tmp.name = commonName;
//                   if (typeof(tmp.name) == "undefined")
//                       console.log("warning, undefined name");
//                   tmp.extinctionTime = d.Year;
//                   var country = d.Countries.split(",");
//                   tmp.country = country;
//                   temp.push(tmp);
//               }
//           });
//       }
//       value.extinction = temp;
//       extinctionByTime.push(value);
//   });
//   return extinctionByTime;
// }
</script>

</body>